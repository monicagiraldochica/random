<%
  # your image location will differ
  image="/hpc/containers/rocky_8_xfce_latest.sif"

  mem = case job_type
          when "normal"
            "90"
          when "bigmem"
            "360"
          when "gpu"
            "90"
          else
            "30"
          end

  ntasks = case job_type
          when "quick"
            "4"
          else
            "12"
          end

  partition = case job_type
          when "bigmem"
            "bigmem"
          when "gpu"
            "gpu"
          else
            "normal"
          end

  base_slurm_args = []
  slurm_args = case job_type
          when "gpu"
            base_slurm_args + ["--gres", "gpu:1"]
          when "quick"
            base_slurm_args + ["--qos", "dev"]
          else
            base_slurm_args
          end
%>
---
script:
  email: <%= ENV["USER"] %>@mcw.edu
  native:
    - "--nodes=1"
    - "--ntasks-per-node=<%= ntasks %>"
    - "--mem=<%= mem %>Gb"
    - "--account=<%= account %>"
    - "--partition=<%= partition %>"
    <%- slurm_args.each do |arg| %>
    - "<%= arg %>"
    <%- end %>
    <%- if email_time_warning -%>
    - "--mail-user=<%= ENV["USER"] %>@mcw.edu"
    - "--mail-type=TIME_LIMIT_90"
    <%- end -%>

batch_connect:
  template: "vnc"
  websockify_cmd: '/usr/bin/websockify'
  script_wrapper: |
    module purge
    module load singularity
    cat << "CTRSCRIPT" > container.sh
    export PATH="$PATH:/opt/TurboVNC/bin"
    %s  
    CTRSCRIPT

    # your bindpath will differ
    singularity exec <%= image %> /bin/bash container.sh

